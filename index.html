<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two Column Layout</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="columns-wrapper">
            <div class="left-column">
                <div class="section">
                    <div class="section-title">Gains</div>
                </div>
                <div class="section">
                    <div class="section-title">Fatigue</div>
                </div>
                <div class="section">
                    <div class="section-title">Gains</div>
                </div>
                <div class="dumbbell">
                    <div class="dumbbell-weight"></div>
                    <div class="dumbbell-bar"></div>
                    <div class="dumbbell-weight"></div>
                </div>
            </div>
            <div class="right-column">
                <div class="stats-section">
                    <div class="stat-item">
                        <div class="stat-label">XP</div>
                        <div class="stat-value" id="strengthValue">0</div>
                        <div class="stat-hint">Tap and release the dumbbell over 'Gains' to gain XP.</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Weight</div>
                        <div class="stat-value" id="weightValue">50</div>
                        <div class="stat-hint">Increase your XP to lift more weight and earn rewards.</div>
                    </div>
                </div>

                <div class="status-effects-section">
                    <div class="status-effects-title">Status Effects</div>
                    <div class="effects-list" id="effectsList">
                        <!-- Effects will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="button-container">
            <button class="add-weight-button" id="addWeightButton" disabled>
                <span>Add Weight</span>
                <span class="button-subtext">Requires 20 XP</span>
            </button>
            <button class="lift-button" id="liftButton">
                <span>Lift</span>
                <span class="button-subtext">Tap and hold</span>
            </button>
        </div>
    </div>

    <div class="debug-menu" id="debugMenu">
        <div class="debug-title">Debug Menu</div>
        <button class="debug-button" id="expireEffectsButton">Expire All Effects</button>
    </div>

    <script>
        const dumbbell = document.querySelector('.dumbbell');
        const liftButton = document.getElementById('liftButton');
        const addWeightButton = document.getElementById('addWeightButton');
        const strengthValue = document.getElementById('strengthValue');
        const weightValue = document.getElementById('weightValue');
        const effectsList = document.getElementById('effectsList');
        const debugMenu = document.getElementById('debugMenu');
        const expireEffectsButton = document.getElementById('expireEffectsButton');
        
        let isLifting = false;
        let isLowering = false;
        let startTime = null;
        let animationFrame = null;
        let currentPosition = 75; // Track current position
        let liftStartPosition = 75; // Track where lift started from
        let strength = 0;
        let weight = 50;
        let liftStartSection = null;
        let fatigueStacks = 0;
        let fatigueTimeRemaining = 0;
        let fatigueTimerInterval = null;
        let autoDropTimer = null;
        
        // Debug menu state
        const debugSequence = ['ArrowUp', 'ArrowDown', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
        let debugInput = [];

        function updateFatigueDisplay() {
            if (fatigueStacks === 0) {
                effectsList.innerHTML = `
                    <div class="effect-description" style="padding: 12px 0;">
                        You currently have no conditions that affect your lifting abilities
                    </div>
                `;
                return;
            }

            const stackText = fatigueStacks > 1 ? ` x${fatigueStacks}` : '';
            const percentage = Math.min(fatigueStacks * 10, 100);
            
            effectsList.innerHTML = `
                <div class="effect-item">
                    <div class="effect-header">
                        <div class="effect-name">Fatigue${stackText}</div>
                        <div class="effect-timer" id="fatigueTimer">${fatigueTimeRemaining}s</div>
                    </div>
                    <div class="effect-description">Reduces maximum barbell lifting height by ${percentage}%</div>
                </div>
            `;
        }

        function addFatigueStack() {
            if (fatigueStacks >= 10) return; // Max 10 stacks (100%)
            
            fatigueStacks++;
            fatigueTimeRemaining += 30;
            
            // Cap total duration at 120 seconds
            if (fatigueTimeRemaining > 120) {
                fatigueTimeRemaining = 120;
            }
            
            updateFatigueDisplay();
            
            // Start timer if not already running
            if (!fatigueTimerInterval) {
                fatigueTimerInterval = setInterval(() => {
                    if (fatigueTimeRemaining > 0) {
                        fatigueTimeRemaining--;
                        const timerEl = document.getElementById('fatigueTimer');
                        if (timerEl) {
                            timerEl.textContent = fatigueTimeRemaining + 's';
                        }
                    } else {
                        fatigueStacks = 0;
                        clearInterval(fatigueTimerInterval);
                        fatigueTimerInterval = null;
                        updateFatigueDisplay();
                    }
                }, 1000);
            }
        }

        // Calculate which section the dumbbell is in
        function getCurrentSection() {
            const leftColumn = document.querySelector('.left-column');
            const columnHeight = leftColumn.clientHeight;
            const sectionHeight = columnHeight / 3;
            
            // Calculate position from top (inverse of bottom)
            const positionFromTop = columnHeight - currentPosition;
            
            if (positionFromTop < sectionHeight) {
                return 'gains-top';
            } else if (positionFromTop < sectionHeight * 2) {
                return 'fatigue';
            } else {
                return 'gains-bottom';
            }
        }

        function isInGainsSection(section) {
            return section === 'gains-top' || section === 'gains-bottom';
        }

        function updateAddWeightButton() {
            if (strength >= 20) {
                addWeightButton.disabled = false;
            } else {
                addWeightButton.disabled = true;
            }
        }

        function animateLift(timestamp) {
            if (!isLifting) return;
            
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            
            // Calculate max height considering fatigue
            const baseMaxHeight = window.innerHeight - 100;
            const minHeight = 75;
            const totalLiftableDistance = baseMaxHeight - minHeight;
            const fatigueReduction = Math.min(fatigueStacks * 10, 100) / 100; // 10% per stack, max 100%
            const maxLiftableDistance = totalLiftableDistance * (1 - fatigueReduction);
            const endPos = minHeight + maxLiftableDistance;
            
            const distanceToTravel = endPos - liftStartPosition;
            const totalDistance = baseMaxHeight - 75;
            const duration = 2000 * (distanceToTravel / totalDistance); // Scale duration to remaining distance
            
            let progress = Math.min(elapsed / duration, 1);
            progress = 1 - Math.pow(1 - progress, 3); // Cubic ease-out for smooth motion
            
            // Move from lift start position to max allowed position
            currentPosition = liftStartPosition + (endPos - liftStartPosition) * progress;
            
            dumbbell.style.bottom = `${currentPosition}px`;
            
            if (progress < 1) {
                animationFrame = requestAnimationFrame(animateLift);
            } else {
                // Bar has reached the top, start 1-second timer for auto-drop
                if (!autoDropTimer && isLifting) {
                    autoDropTimer = setTimeout(() => {
                        stopLift();
                    }, 1000);
                }
            }
        }

        function animateLower(timestamp) {
            if (!isLowering) return;
            
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            
            // Use ease-in cubic for smooth acceleration downward
            const duration = 1500; // 1.5 seconds to return to bottom
            let progress = Math.min(elapsed / duration, 1);
            progress = Math.pow(progress, 2); // Quadratic ease-in for smooth drop
            
            // Move from current position back to 75px
            const startPos = currentPosition;
            const endPos = 75;
            currentPosition = startPos + (endPos - startPos) * progress;
            
            dumbbell.style.bottom = `${currentPosition}px`;
            
            if (progress < 1) {
                animationFrame = requestAnimationFrame(animateLower);
            } else {
                isLowering = false;
                currentPosition = 75;
            }
        }

        function startLift() {
            // Cancel any ongoing animation
            if (animationFrame) cancelAnimationFrame(animationFrame);
            
            // Clear auto-drop timer if exists
            if (autoDropTimer) {
                clearTimeout(autoDropTimer);
                autoDropTimer = null;
            }
            
            // Check if starting in Fatigue section
            const startSection = getCurrentSection();
            if (startSection === 'fatigue') {
                addFatigueStack();
            }
            
            // Add visual feedback
            liftButton.classList.add('lifting');
            dumbbell.classList.add('shaking');
            
            // Record which section we're starting in
            liftStartSection = startSection;
            
            // Start lifting from current position
            isLifting = true;
            isLowering = false;
            startTime = null;
            liftStartPosition = currentPosition; // Resume from wherever we are now
            
            animationFrame = requestAnimationFrame(animateLift);
        }

        function stopLift() {
            if (animationFrame) cancelAnimationFrame(animationFrame);
            
            // Clear auto-drop timer if exists
            if (autoDropTimer) {
                clearTimeout(autoDropTimer);
                autoDropTimer = null;
            }
            
            // Remove lifting state
            liftButton.classList.remove('lifting');
            dumbbell.classList.remove('shaking');
            
            // Check if we released in Fatigue section
            const releaseSection = getCurrentSection();
            if (releaseSection === 'fatigue') {
                addFatigueStack();
            }
            
            // Check if we started and ended in different Gains sections
            if (isInGainsSection(liftStartSection) && 
                isInGainsSection(releaseSection) && 
                liftStartSection !== releaseSection) {
                strength += 5;
                strengthValue.textContent = strength;
                updateAddWeightButton();
                
                // Add success feedback
                liftButton.classList.add('success');
                setTimeout(() => {
                    liftButton.classList.remove('success');
                }, 400);
            }
            
            // Start lowering from current position
            isLifting = false;
            isLowering = true;
            startTime = null;
            
            animationFrame = requestAnimationFrame(animateLower);
        }

        // Mouse events
        liftButton.addEventListener('mousedown', startLift);
        liftButton.addEventListener('mouseup', stopLift);
        liftButton.addEventListener('mouseleave', stopLift);

        // Touch events
        liftButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startLift();
        });
        liftButton.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopLift();
        });
        liftButton.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            stopLift();
        });

        // Debug menu keyboard sequence detection
        document.addEventListener('keydown', (e) => {
            debugInput.push(e.key);
            
            // Keep only the last 6 keys
            if (debugInput.length > debugSequence.length) {
                debugInput.shift();
            }
            
            // Check if sequence matches
            if (debugInput.length === debugSequence.length) {
                const matches = debugInput.every((key, index) => key === debugSequence[index]);
                if (matches) {
                    debugMenu.classList.toggle('visible');
                    debugInput = []; // Reset sequence
                }
            }
        });

        // Expire all effects button
        expireEffectsButton.addEventListener('click', () => {
            fatigueTimeRemaining = 0;
            fatigueStacks = 0;
            if (fatigueTimerInterval) {
                clearInterval(fatigueTimerInterval);
                fatigueTimerInterval = null;
            }
            updateFatigueDisplay();
        });

        // Initialize display on page load
        updateFatigueDisplay();
    </script>
</body>
</html>